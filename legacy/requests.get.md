# requests.get

> pythonç½‘ç»œç¼–ç¨‹ç»ƒä¹ è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ å¿ƒè¡€æ¥æ½®å¯¹å½“æ—¶pythonçš„requeståº“çš„ä¸€ç•ªæ¢ç©¶

ç”¨`c` `socket` å†™çš„è·Ÿ`python` `requests.get`ä¸ä¸€è‡´
å³ä½¿`header`ç›¸åŒï¼ŒæŠ“å–çš„`DOM`ä¹Ÿæœ‰åŒºåˆ«ï¼Œ ä¸€ä¸ª1700è¡Œï¼Œ ä¸€ä¸ªæ‰200å¤š
`header`å­—æ®µä¸ä¸€æ ·ï¼Œå…‰ç›¸åº”å¤´è·Ÿéƒ¨åˆ†`meta`,æ–‡æœ¬éƒ½å‡ºä¸æ¥æ˜¯ä»€ä¹ˆé¬¼ï¼Œ `user-agent`æ¢æˆ`python-requests`, `body`è‡³å°‘æœ‰äº†ç‚¹

### requests 2.24.0
`get`è°ƒç”¨çš„æ˜¯`Session`å¯¹è±¡çš„`request`æ–¹æ³•

å¯¹ä¸€ä¸ªä¼šè¯å®ä¾‹ï¼Œå®ƒæœ‰ä»¥ä¸‹å±æ€§
-    `header`é»˜è®¤å­—æ®µåŒ…æ‹¬`User-Agent`ã€`Accept-Encoding`ã€`Accept`å’Œ`Connection`ï¼Œ
-   `hook` äº‹ä»¶å¥æŸ„é’©å­é»˜è®¤ä¸ºä¸€ä¸ªä»…æœ‰`response`é”®çš„å­—å…¸,   å€¼é»˜è®¤ä¸º`list`
-    `verify`ä¸º`True`é»˜è®¤å¼€å¯`ssl`éªŒè¯
-    `cookie`ä¸ºä¸€ä¸ª`RequestsCookieJar`å¯¹è±¡,  å®åˆ™æ˜¯`cookielib`æ¨¡å—ä¸‹`CookieJar`çš„`dict`æ¥å£ï¼Œå°†`cookie`å‚æ•°ä¼ å…¥çš„æ›´æ–°åˆ°`cookiejar`ä¸­
-    `adapters`ä¸ºæœ‰åºå­—å…¸ï¼Œ é»˜è®¤ä¼šæ³¨å…¥`http`ã€`https`å‰ç¼€çš„`HTTPAdapter`å¯¹è±¡

å†å›åˆ°`request`æ–¹æ³•ï¼Œ `request`æ–¹æ³•æ„é€ ä¸€ä¸ª`Request`å®ä¾‹ï¼Œé€šå¸¸çš„`get`è°ƒç”¨åªæŒ‡ä¼ é€’`get`æ–¹æ³•åã€`url`å’Œé»˜è®¤çš„`allow_redirects`å…è®¸é‡å®šå‘å­—æ®µåˆ°`Request`æ„é€ å™¨ï¼Œ

æ¥ç€`session`è°ƒç”¨`prepare_request`æ–¹æ³•ä¼šå°†`request`ä¸­çš„`cookie`å‚æ•°ä¸`session`ä¸­çš„`cookie`æ•´åˆï¼Œ åœ¨å®‰å…¨ç¯å¢ƒä¸‹ï¼Œä¼šè¯ä¸è¯·æ±‚éƒ½æ²¡æ˜¾ç¤ºè®¾ç½®æƒé™æ—¶ï¼Œä¼šå°è¯•ç”¨`netrc`æ¨¡å—è·å–æˆæƒ,  é€šå¸¸ä¼šè¿”å›ç©ºå€¼`requests.utils.get_netrc_auth('news.sohu.com')`

æœ€åå†å°†`Request`å†`wrapper`ä¸€å±‚ä¸º`PreparedRequest`ï¼Œ è°ƒç”¨å…¶`prepare`æ–¹æ³•, è¿™æ¬¡ä¼šåšäº›æ›´ä¸ºç»†è…»çš„æ“ä½œï¼Œå°†`get`æ–¹æ³•è½¬ä¸ºå¤§å†™å†è¿›è¡Œ`ascii`ç¼–ç ï¼Œ æ•´åˆä¼šè¯ä¸è¯·æ±‚çš„å‚æ•°ç­‰ï¼Œ å†…éƒ¨ä¼šè°ƒç”¨å¤šä¸ªå¤„ç†å‡½æ•°
-    `prepare_method` å…¼å®¹`py2.x`
-    `prepare_url` æ ¼å¼åŒ–`url`, å°†`http`åè®®çš„`url`è§£æï¼Œæ­£åˆ™åŒ¹é…å„ä¸ªå­—æ®µï¼ŒçŸ«æ­£ã€é‡ç»„
-    `prepare_headers` é¦–éƒ¨æ ¼å¼åŒ–ï¼Œé”®å€¼æ”¾å…¥éå¤§å°æ•æ„Ÿå­—å…¸ä¸­ï¼Œ æ ¸å¯¹é”®å€¼å¯¹çš„æœ‰æ•ˆæ€§
-    `prepare_cookie` å°†`cookie`æ³¨å…¥é¦–éƒ¨ï¼Œ å…ˆæ˜¯æ„é€ `MockRequest`ï¼Œ ç„¶ååœ¨`CookieJar`çš„`add_cookie_header`æ–¹æ³•é‡Œè§£æ`cookie`æ¥å®Œæˆ`mock`
-    `prepare_body` è¯·æ±‚æ•°æ®æ£€æŸ¥ï¼Œæ–‡æœ¬è¿˜æ˜¯ç”Ÿæˆå™¨ã€è¿­ä»£å™¨ã€å¥æŸ„ï¼Œ æµæ˜¯å¦åˆ†å—ï¼Œ å¥æŸ„æŒ‡é’ˆç»“æŸæ ‡è¯†ï¼Œä¸ºè¡¨å•æ•°æ®æ·»åŠ ç›¸åº”é¦–éƒ¨å­—æ®µ`Content-Type`
-    `prepare_auth`  `session`çš„`auth`å±æ€§é»˜è®¤æ˜¯`None`çš„ï¼Œ è¿™é‡Œä¼šè§£æ`url`ä¸­çš„`auth`ä¿¡æ¯ï¼Œ è‹¥`url`ä¸­åŒ…å«`auth`ï¼Œ ä»¥æ­¤`auth`æ„é€ `HTTPBasicAuth`å®ä¾‹ï¼Œ å¹¶æ›´æ–°åˆ°`session`ä¸­ï¼Œ åŒæ—¶æ›´æ–°`body`é•¿åº¦
-    `prepare_hooks` æ³¨å†Œé’©å­å‡½æ•°å‰é¡»å®Œæˆ`auth`çš„ç›¸å…³æ£€æŸ¥ï¼Œå› ä¸º`auth`å¯ä»¥æ·»åŠ é’©å­ï¼Œä¸èƒ½æ¼

`session`é»˜è®¤æ˜¯æ— ä»£ç†çš„ï¼Œè¿™æ ·ä¸€æ¥ï¼Œ `send`æ–¹æ³•å°±ä»…å‘é€ä¸€ä¸ª`PreparedRequest`ä¸å…è®¸é‡å®šå‘å­—æ®µï¼Œ
`send`æ–¹æ³•å®é™…æ˜¯è°ƒç”¨çš„`adapter`çš„`send`æ–¹æ³•,   ç„¶åå°±æ˜¯`httplib`ã€`urllib3`ç­‰å°è£…çš„`socket`æŠ½è±¡åº“å®ç°çš„ä¼šè¯ï¼Œæ”¶å‘æ¶ˆæ¯

```python
import socket, ssl
def cwl(url):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

    sock.connect((url, 443))

    sock = ssl.wrap_socket(sock)

    req = '''\
GET / HTTP/1.1\r\n\
Host: news.sohu.com\r\n\
User-Agent: python-requests/2.24.0\r\n\
Content-Language: zh-CN\r\n\
Connection: Close\r\n\
\r\n\
'''
    sock.sendall(req.encode('ascii'))

    f = open('d.html', 'w', encoding='utf8')
    raw = b''
    while 1:
        more = sock.recv(1<<12)
        # import ipdb; ipdb.set_trace()
        f.write(more.decode())
        if not more: break
        raw += more
  
    sock.close()
    f.close()
```
ä»Šå¤©å°è¯•ç”¨`python`çš„`socket`æŠ“æœç‹é¦–é¡µï¼Œ å°†é—®é¢˜åˆé‡æ–°å®šä½äº†ä¸‹ï¼Œä¸€å¼€å§‹ç”¨ `python`çš„`plain` `http`è¯·æ±‚ç›´æ¥è¿”å›çš„`400`ï¼Œ è¿˜ä»¥ä¸ºä¼šè·Ÿ`c`ä¸€æ ·`443`ç«¯å£è¿æ¥å»ºç«‹åè‡ªåŠ¨åå•†ï¼Œ è€å®å¥—ä¸Š`ssl`åå‘ç°ä¸€æ ·æ˜¯`200`å¤šè¡Œçš„å“åº”ï¼Œ è€Œä¸”ä½ç½®ä¹Ÿå·®ä¸å¤šï¼Œ `ipdb`è°ƒä¸‹å‘ç°å¸¸ç”¨çš„ç¼–ç æ€ä¹ˆéƒ½è¿‡ä¸äº†ï¼Œ æ„Ÿè§‰é—®é¢˜è·Ÿå“åº”çš„è§£æå¯èƒ½ä¹Ÿæœ‰å…³ç³»ï¼Œå¤´å¤§

sbäº†ï¼Œ ä¸ç”¨`ssl`åŠ å¯†è¿`443`ç«¯å£è¿æ¥éƒ½å»ºç«‹ä¸èµ·æ¥

---
```python
import socket, ssl

def cwl(host, port):
    req = f'''\
GET / HTTP/1.1\r\n\
Host: {host}\r\n\
User-Agent: wcw-demo\r\n\
Connection: Close\r\n\
\r\n\
'''

    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((host, port))
    sock = ssl.wrap_socket(sock)
    
    sock.sendall(req.encode('utf8'))

    res = b''
    f = open('a.htm', 'w',  encoding='utf8')
    while 1:
        try:
            more = sock.recv(128)
            if not more: break
            # f.write(more.decode('utf8'))
            res += more 
        except Exception as e:
            f.close()
            print(e)

    f.write(str(res, 'utf-8', errors='replace'))
    f.close()
```    
åšäº‹å‰è¿˜æ˜¯å¾—å¤šæƒ³æƒ³ï¼Œ è¯¯ä»¥ä¸ºä¼šé€è¡Œè§£æå“åº”ï¼Œ çœ‹åˆ°`urllib3`çš„è¿æ¥æ± å»äº†
æœ€åæ€»ç®—å®šä½åˆ°é—®é¢˜ï¼Œ  å…¨éƒ¨çš„äºŒè¿›åˆ¶å“åº”æ¥å—åï¼Œ åœ¨`model.py`ä¸­ä¸€å¤„æ•´ä½“è¿›è¡Œè§£æ
`content = str(self.content, encoding, errors='replace')`
`python`çš„`str`ç±»æ„é€ å‡½æ•°æœ‰æä¾›ç¼–ç é”™è¯¯çš„åº”å¯¹æœºåˆ¶
å…·ä½“ç»†èŠ‚å¾—å»çœ‹`python`è§£é‡Šå™¨çš„`C`åº“äº†

---
`python`çš„è§£ç å‡½æ•°`decode`å¯¹æŒ‡å®šç¼–ç å¤–çš„é”™è¯¯ç¼–ç å­—èŠ‚ï¼Œ é€šå¸¸ä¼šç›´æ¥æŠ›å‡º`UnicodeError`å¼‚å¸¸ï¼Œ
æŒ‡å®š`errors`å‚æ•°é‡‡å–ä¸åŒçš„åº”å¯¹å¤„ç†ç­–ç•¥
-    `replace`, ä½¿ç”¨`U+FFFD`æ¥æ›¿æ¢é”™è¯¯ç¼–ç å­—èŠ‚
-    `ignore`, å»æ‰è¯¥å­—ç¬¦
-    `blackslashreplace`,  ä¸ºå­—ç¬¦æ·»åŠ è½¬ä¹‰ç¬¦`\`

æˆ‘ç°åœ¨çš„çœ‹æ³•æ˜¯ï¼Œ å“åº”ç»è¿‡å±‚å±‚ä¼ é€’ï¼Œ ä»¥åŠ`unicode`çš„å¤šå­èŠ‚å­—ç¬¦ï¼Œ å¾ˆå¯èƒ½åœ¨æ•°æ®åŒ…ä¼ é€’çš„è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œ ä¸€ä¸ª`bit`ä½å˜åŒ–å°±ä¼šæœ‰å­—èŠ‚å—å½±å“ï¼Œ çº é”™æ ¡éªŒé€šå¸¸ä¹Ÿæ˜¯åŸºäºè®¡æ•°ï¼Œ ä»å¯èƒ½æ¼æ‰å¼‚å¸¸ï¼Œé’ˆå¯¹ç°åœ¨çš„é—®é¢˜ï¼Œéœ€è¦çš„æ˜¯ä¸€ä¸ªå¯¹å¼‚å¸¸`utf8`ç¼–ç å¤„ç†çš„å‡½æ•°,  

è¿˜æ˜¯æœ‰é—®é¢˜ğŸ˜‚

---
å”‰ï¼Œ Cçˆ¬ä¸‹æ¥éƒ½é”™è¯¯ç¼–ç ä¸å½±å“è§£ç ï¼Œ å“åº”åºåˆ—é•¿åº¦ä¸å¯¹ä¸»è¦åœ¨äºï¼Œ `while`å¾ªç¯`recv`çš„é€€å‡ºæ¡ä»¶ï¼Œ ä¸åƒ`python`ä¸­æ¯æ¬¡å°±æ˜¯`recv`æŒ‡å®šçš„å“åº”é•¿åº¦ï¼Œ å°äºå…¶é•¿åº¦æ—¶å°±é€€å‡ºäº†ï¼Œ è¿˜æ˜¯å¾—æ¥å—å­åºåˆ—é•¿åº¦ä¸º0æ‰é€€å‡ºå¾ªç¯ï¼Œ ç„¶åå°±æ˜¯`realloc`è°ƒæ•´åŠ¨æ€å†…å­˜é•¿åº¦çš„æ¡ä»¶ï¼Œ æ„Ÿè§‰æ˜æ˜å¾ˆéš¾åˆšå¥½åˆ°æŒ‡å®šçš„çª—å£ï¼Œ å…ˆå‰çš„`>=`ä¸€ç›´æŠ¥é”™`realloc error`, å½“ç„¶æ›´ç®€å•çš„æ–¹æ³•æ˜¯ç›´æ¥åœ¨åˆæ¬¡`malloc`æ—¶å°†`bufsize`è®¾åˆ°æœ€å¤§

---
å®Œç»“ï¼Œ `python`çš„ä¸å®Œæ•´å“åº”åœ¨äºè§£ç é”™è¯¯ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯`errors`å‚æ•°çš„è®¾ç½®ï¼Œ `ignore`æˆ–æ˜¯`replace`,
`c`ä¸­çš„é—®é¢˜åœ¨äºä¹‹å‰`while`è¯»æ“ä½œçš„é€€å‡ºæ¡ä»¶ä¸å‡†ï¼Œ `buffer`è®¾ç½®å¤ªå°`realloc`å†åˆ†é…æ”¾å¤§çš„ä½¿ç”¨ä¸å½“é€ æˆï¼Œ å®åœ¨å¤ªå¤§å¯ä»¥é‡‡ç”¨æŒ‡é’ˆæ•°ç»„ï¼Œ åˆ†æ‰¹æ¬¡å­˜å‚¨å“åº”æŠ¥æ–‡

<!-- 2020å¹´7æœˆ28æ—¥ 22:30 -->